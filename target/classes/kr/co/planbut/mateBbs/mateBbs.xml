<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- notice.xml -->
<!-- 실행할 SQL문을 정의해놓은 파일 -->

<!-- MyBatis에서는 namespace를 필수로 설정해야한다 -->
<!-- namespace = "패키지명.인터페이스" -->
<mapper namespace="kr.co.planbut.mateBbs.MateBbsMapper">
	<!-- 
	■ 데이터베이스 결과 데이터를 객체에 매핑하는 방법을 정의 
	■ ResultSet 에서 가져와서 DTO에 담는것과 비슷하다
	■ 기본키(PK)는 <id>에 지정
	-->

	<insert id="create" parameterType="MateBbsDTO"> <!-- setter 함수가 있기에 parameterType사용 가능 -->
		<selectKey keyProperty="b_no" resultType="int" order="BEFORE"> 
		<!-- keyProperty = "변수명", 변수가 a 라면 밑에 b_no도 a 로 바꿔줘야한다 -->
		<![CDATA[
			select ifnull(max(b_no),0)+1 as b_no
			from mateboard as TB
		]]>
		</selectKey>
		
		<![CDATA[
			INSERT INTO mateboard(b_no, mp_id, regdt, subject, content, ct_code, m_date, gender, capacity)
			values(#{b_no}, #{mp_id}, now(), #{subject}, #{content}, #{ct_code}, #{m_date}, #{gender}, #{capacity}) 
		]]>
		<!-- getter 함수가 있기에 values에 값을 꺼내올 수 있다 -->
	</insert>
	
	<select id="list" resultType="MateBbsDTO">
	    <![CDATA[
		    select if(aa.pp=null,0,aa.pp) people, BB.b_no, BB.mp_id, BB.regdt, BB.subject, BB.content, BB.ct_code, BB.m_date, BB.gender, BB.capacity
            from(
                select b_no, sum(people) pp
                from mateapply_b TB
                order by b_no desc
            ) AA right join mateboard BB
            on AA.b_no = BB.b_no
            order by b_no desc
		]]>
	</select>
	
	<delete id="delete" parameterType="MateBbsDTO">
	    <![CDATA[
			delete from mateboard
			where b_no = #{b_no}
		]]>
	</delete>
	
	<select id="read" parameterType="MateBbsDTO" resultType="MateBbsDTO">
        <![CDATA[
            select b_no, mp_id, subject, content, ct_code, m_date, gender, capacity, regdt
	        from mateboard as TB
	        where b_no=#{b_no}
        ]]>
    </select>
    
    <update id="update" parameterType="MateBbsDTO">
        <![CDATA[
            update mateboard
            set subject= #{subject}, content= #{content}, gender=#{gender}, ct_code=#{ct_code}, capacity=#{capacity}, m_date=#{m_date}
            where b_no = #{b_no}
        ]]>
    </update>
    
    <select id="recmList" parameterType="CityPlanDTO" resultType="CityPlanDTO">
        <![CDATA[
            select aa.ct_code, aa.s_date
            from(select plan_code, ct_code, s_date
            from cityplan
            where rm_ok='Y')aa join planner bb
            on aa.plan_code=bb.plan_code
            where bb.m_id='aaaa' and aa.s_date>=now()
        ]]>
    </select>
    
	<!--
	<select id="search" resultType="MateBbsDTO" parameterType="HashMap">
		select noticeno, title, rname, rdate
		from notice5
		<choose>
			<when test="col == 'title'">
				where title like '%' || #{word} || '%'
			</when>
			<when test="col == 'rname'">
				where rname like '%' || #{word} || '%'
			</when>
			<when test="col == 'title_rname'">
				where title like '%' || #{word} || '%' or rname like '%' || #{word} || '%'
			</when>
		</choose>
		order by noticeno desc
	</select> -->
</mapper>